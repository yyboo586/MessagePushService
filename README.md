## 消息推送逻辑
### 持久化
- 基于消息唯一标识实现幂等。

### 推送
- 基于乐观锁/悲观锁实现推送幂等。


# 可靠性分析
- 在WebSocket通信中，服务端需要知晓客户端成功接收并处理消息，需要区分 TCP传输层确认 和 应用层确认 两个层面:
    - 前者是协议内置的基础保障
    - 后者需要结合业务场景自定义实现
- TCP传输层的基础确认 不代表 应用层接收。
    - WebSocket协议基于TCP协议实现，而TCP协议本身是"可靠传输协议"，具备"三次握手、字节流确认(ACK)、重传"等机制。
    - 当服务端通过WebSocket发送消息后，TCP协议栈会自动向服务器端返回"ACK确认"，表示"客户端的TCP层已成功收到该数据段"。
    - 但是，TCP层的ACK仅能确认"数据到达客户端的操作系统内核"，无法确认"客户端应用层已成功读取、解析并处理消息"。
    - 比如: 客户端TCP层收到数据，但应用层代码崩溃、代码Bug未读取缓冲区数据，此时TCP仍会返回ACK，但业务上等于"未接收"。

- 原生WebSocket协议的局限: 无内置应用层确认
    - Ping/Pong帧用于检测连接存活状态，不能确认消息已接收。
    - Close帧用于优雅断连，与消息确认无关。

- 自定义应用层消息确认机制
    - 服务端发送消息
    - 客户端回复ACK
    - 服务端确认ACK
    - 超时重发、消息去重等机制

# 聊天室场景
## 在线用户的消息实时分发
- 消息接收与校验
- 消息持久化存储
- 在线用户筛选
- 消息主动推送
- 消息状态变更

## 离线用户历史记录同步
- 离线同步的触发时机
    - 用户登录后，同步聊天室历史信息
    - 用户离线后重新连接聊天室时

- 历史记录的存储与拉取策略
    - 热点缓存层: 近1小时的消息
    - 持久存储层: 所有历史消息

- 避免重复同步
    - 基于消息ID唯一标识去重

## 同步的可靠性与一致性
- 消息确认机制：避免推送丢失
- 消息顺序保证：按时间戳排序
- 大群聊的性能优化: 分片/限流
    - 消息分片推送：将在线用户分为多个批次，分批次推送。
    - 合并小消息：需要客户端支持批量解析
    - 读写分离

# 并发编程
- https://blogtitle.github.io/categories/concurrency/
- https://drive.google.com/file/d/1nPdvhB0PutEJzdCq5ms6UI58dp50fcAN/view?pli=1
- sync.Cond
- C10K问题

## 并发执行单元
- 进程
    - 资源分配的基本单位，拥有独立的内存空间、文件句柄等
    - 进程间互相隔离
    - 创建、销毁和切换的成本高
    - 进程间通信(IPC)比较复杂
- 线程
    - CPU调度的基本单位
    - 线程的创建、销毁、切换成本比进程低，但仍然不算轻量
    - 同一个进程内的线程共享进程的内存空间和资源
    - 线程间通信(ITC)较为简单，只需访问共享内存即可，但这也带来了数据竞争问题
- 协程
    - 运行在用户态的轻量级线程，它的调度完全由用户程序控制(runtime)
    - 极度轻量: 初始栈空间仅(2KB)，创建、销毁、切换成本低
    - 调度开销小: 调度发生在用户态，不涉及复杂的系统调用和内核上下文切换，成本低。

## 并发编程的核心挑战与解决方案
### 竞态条件 && 数据竞争
- 竞态条件
    - 程序结果依赖于不受控的事件时序
    - 是一种广义的问题类别
    - 表现为程序错误
- 数据竞争
    - 未同步的并发内存操作，且含写操作
    - 狭义的、导致竞态条件的一种具体技术原因
    - 导致某种竞态条件的原因
### 死锁
- 两个或以上的执行流互相等待对方释放资源，导致所有执行流都无法继续向下执行。
- 必要条件
    - 互斥: 一个资源每次只能被一个执行流占用。
    - 占有且等待: 一个执行流占有一个资源，同时还在等待另一个资源。
    - 不可抢占: 资源只能由占有它的执行流主动释放。
    - 循环等待: 执行流之间形成一个首尾相连的循环等待关系。

### 共享资源
- 可以被多个并发执行单元同时访问的变量、内存区域、文件、数据库连接等。

### 同步机制
- 协调多个并发执行单元的执行顺序和节奏，以确保它们能够正确、有序地访问共享资源或协作完成一项任务。
    - 避免竞争机制
    - 协调依赖关系
- Go语言中主要的同步机制
    - 同步原语
    - Channel

### 通信
- 指并发执行单元之间交换数据和信息的行为。
- 通信与共享资源的区别
    - 传统的通信是通过共享资源实现的: 发送方将数据写入共享内存，接收方读取共享内存。
    - 这种方式容易出错，因为共享内存需要同步机制。

# 大文件问题
## 读取
- 按块读取(Buffer缓冲读取)
    - 一次性读取固定大小的字节块
    - 减少系统调用，充分利用磁盘缓存
- 内存映射文件(mmap)
    - 直接将文件映射到进程的虚拟内存地址空间
    - 避免大量I/O操作，减少内存拷贝，支持随机访问
- 多线程/多进程并行读取
    - 文件分割处理，且CPU是性能瓶颈（I/O不是瓶颈）
- 流式处理框架
- 文件压缩与分块