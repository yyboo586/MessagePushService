# 消息推送服务

## 功能描述
- 独立的消息推送服务，通过WebSocket向客户端推送消息。
- 其它微服务通过消息队列与消息推送服务交互。
    - 比如身份认证服务：当用户密码变更时，通过消息队列将消息发送给消息推送服务，消息推送服务再把消息推送给客户端，通知用户重新登录。
    - 比如设备接入服务：当设备报警时，通过消息队列将消息发送给消息推送服务，消息推送服务再把消息推送给客户端，告知用户设备异常。
- 目前仅考虑单节点部署。

## 系统架构

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   客户端应用     │    │   消息推送服务    │    │   消息队列      │
│                 │    │                  │    │   (NSQ/RabbitMQ) │
│ ┌─────────────┐ │    │ ┌──────────────┐ │    │                │
│ │ WebSocket   │◄────►│ │ WebSocket    │ │    │                │
│ │ 客户端      │ │    │ │ 服务器        │ │    │                │
│ └─────────────┘ │    │ └──────────────┘ │    │                │
└─────────────────┘    │ ┌──────────────┐ │    │                │
                       │ │ 连接管理器    │ │    │                │
                       │ └──────────────┘ │    │                │
                       │ ┌──────────────┐ │    │                │
                       │ │ 消息处理器    │ │    │                │
                       │ └──────────────┘ │    │                │
                       │ ┌──────────────┐ │    │                │
                       │ │ 身份认证      │ │    │                │
                       │ └──────────────┘ │    │                │
                       └──────────────────┘    │                │
                                │              │                │
                                ▼              │                │
                       ┌──────────────┐        │                │
                       │   数据库     │        │                │
                       │   (MySQL)    │        │                │
                       └──────────────┘        │                │
                                ▲              │                │
                                │              │                │
                       ┌──────────────┐        │                │
                       │   其他微服务  │────────┼────────────────┘
                       │   (认证/设备) │        │
                       └──────────────┘        │
```

## 逻辑设计

### 连接建立
- 客户端携带访问令牌与消息推送服务建立WebSocket连接，建立 userID -> List<WsConn> 内存映射。
- 查询该客户端是否存在 待推送/推送失败 消息，如果有，走消息推送逻辑。

### 消息监听
- 监听MQ消息，先做持久化(MySQL)，再推送消息。

### 消息推送
- 从映射中找到对应的WsConn
    - 如果推送成功，标记该条消息已经推送成功。
    - 如果推送失败，标记为推送失败。
- 消息状态设计
    - 待推送、推送成功、推送失败
- 消息幂等性
    - 确保同一条消息不会重复推送。

## 开发阶段规划

### 第一阶段：基础功能实现 (预计2-3周)
#### 1.1 连接管理模块
- WebSocket连接建立与升级
- 用户身份认证集成
- 连接状态管理
    - 连接心跳检测机制：服务端主动心跳，客户端被动响应。
    - 优雅断开连接处理：
- 并发安全性

#### 1.2 消息处理模块
- 消息队列集成
    - 消息处理失败重试
    - 消息幂等性保证
- 基础JSON消息格式定义
- 消息持久化存储
    - 
- 消息状态跟踪

#### 1.4 数据存储
- [ ] MySQL表结构设计
- [ ] 消息记录表
- [ ] 用户连接状态表
- [ ] 基础CRUD操作

### 技术要点
- 使用gorilla/websocket实现WebSocket服务
- 每个连接使用2个goroutine（读/写）
- 简单的内存连接映射
- 基础的消息格式：`{"type": "text", "data": "message content"}`

### 验收标准
- 客户端能够成功建立WebSocket连接
- 支持基本的消息推送功能
- 连接断开后能够正确清理资源
- 消息能够正确持久化到数据库

---

### 第二阶段：自定义消息格式与协议优化 (预计3-4周)

#### 目标
实现自定义的TCP层消息协议，提升消息传输效率和灵活性。

#### 主要任务

##### 2.1 自定义协议设计
- [ ] 消息头设计（消息类型、长度、序列号等）
- [ ] 消息体序列化/反序列化
- [ ] 协议版本管理
- [ ] 消息压缩支持

##### 2.2 协议实现
- [ ] 二进制消息格式
- [ ] 消息分片与重组
- [ ] 消息校验机制
- [ ] 协议升级兼容性

##### 2.3 性能优化
- [ ] 连接池优化
- [ ] 消息批处理
- [ ] 内存使用优化
- [ ] 并发性能调优

##### 2.4 监控与日志
- [ ] 连接数监控
- [ ] 消息吞吐量统计
- [ ] 错误率监控
- [ ] 性能指标收集

#### 技术要点
- 自定义二进制协议替代JSON
- 消息压缩（gzip/snappy）
- 连接复用优化
- 性能基准测试

#### 验收标准
- 消息传输效率提升30%以上
- 支持消息分片传输
- 完整的协议版本管理
- 详细的性能监控指标

---

### 第三阶段：架构重构与性能优化 (预计4-5周)

#### 目标
弃用gorilla/websocket，采用更高效的WebSocket实现，显著提升并发性能。

#### 主要任务

##### 3.1 替代方案调研
- [ ] 调研高性能WebSocket库
  - [ ] nhooyr.io/websocket
  - [ ] github.com/fasthttp/websocket
  - [ ] 自研轻量级实现
- [ ] 性能对比测试
- [ ] 功能特性对比
- [ ] 社区活跃度评估

##### 3.2 架构重构
- [ ] 新的WebSocket实现集成
- [ ] 连接管理重构
- [ ] 消息处理流程优化
- [ ] 接口兼容性保证

##### 3.3 性能优化
- [ ] 单连接单goroutine设计
- [ ] 事件驱动架构
- [ ] 内存池优化
- [ ] 网络I/O优化

##### 3.4 集群支持
- [ ] 多节点部署支持
- [ ] 节点间消息同步
- [ ] 负载均衡策略
- [ ] 故障转移机制

#### 技术要点
- 单连接单goroutine架构
- 事件驱动而非轮询
- 内存池减少GC压力
- 支持水平扩展

#### 验收标准
- 单机支持10万+并发连接
- 内存使用降低50%以上
- 消息延迟降低到毫秒级
- 支持集群部署

---

## 技术架构设计

### 消息格式规范

#### 第一阶段：JSON格式
```json
{
  "type": "text|binary|notification|alarm",
  "id": "unique_message_id",
  "timestamp": 1640995200000,
  "data": {
    "title": "消息标题",
    "content": "消息内容",
    "level": "info|warning|error"
  }
}
```

#### 第二阶段：自定义二进制格式
```
[Header: 16 bytes][Body: variable length]
Header: [Magic:4][Version:2][Type:2][Length:4][Sequence:4]
Body: [Compressed data]
```

### 数据库设计

#### 消息记录表 (messages)
```sql
CREATE TABLE messages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(64) UNIQUE NOT NULL,
    user_id VARCHAR(64) NOT NULL,
    type VARCHAR(32) NOT NULL,
    title VARCHAR(255),
    content TEXT,
    status ENUM('pending', 'sent', 'failed') DEFAULT 'pending',
    retry_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_status (user_id, status),
    INDEX idx_created_at (created_at)
);
```

#### 连接状态表 (connections)
```sql
CREATE TABLE connections (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id VARCHAR(64) NOT NULL,
    connection_id VARCHAR(64) NOT NULL,
    status ENUM('online', 'offline', 'reconnecting') DEFAULT 'online',
    last_heartbeat TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_conn (user_id, connection_id),
    INDEX idx_status_heartbeat (status, last_heartbeat)
);
```

### 性能指标

#### 第一阶段目标
- 单机支持1000并发连接
- 消息延迟 < 100ms
- 内存使用 < 500MB

#### 第二阶段目标
- 单机支持5000并发连接
- 消息延迟 < 50ms
- 内存使用 < 300MB

#### 第三阶段目标
- 单机支持10万+并发连接
- 消息延迟 < 10ms
- 内存使用 < 200MB

## 风险与挑战

### 技术风险
1. **gorilla/websocket性能瓶颈**：每个连接需要2个goroutine
2. **内存管理**：大量连接可能导致内存泄漏
3. **网络I/O**：高并发下的网络性能瓶颈

### 业务风险
1. **消息丢失**：网络异常导致的消息丢失
2. **重复推送**：消息幂等性保证
3. **连接稳定性**：客户端网络波动处理

### 缓解措施
1. **性能测试**：每个阶段进行充分的性能测试
2. **监控告警**：建立完善的监控体系
3. **容错机制**：实现重试、降级等容错策略
4. **代码审查**：严格的代码审查流程

## 总结

本项目采用渐进式开发策略，通过三个阶段的迭代，逐步实现一个高性能、可扩展的消息推送服务。每个阶段都有明确的目标和验收标准，确保开发过程的可控性和质量。

第一阶段建立基础功能，第二阶段优化协议和性能，第三阶段进行架构重构。这种渐进式方法可以：
- 快速验证核心功能
- 持续优化性能
- 降低开发风险
- 便于问题定位和修复


## 问题统计
### 连接被拒绝
- dial tcp [::1]:9701: connectex: No connection could be made because the target machine actively refused it
- 服务器连接数限制
    - 操作系统限制：Windows对单进程的并发连接数有限制
    - WebSocket服务器限制：服务没有配置足够高的并发数
    - 端口限制：单个端口能处理的连接数有限
- 资源耗尽
    - 内存不足
    - 文件描述符限制：每个连接都需要文件描述符
    - 网络缓冲区满：服务端网络缓冲区可能已满

# Test Data
```
User01: 
ID: b3fc6c49-93ea-485b-a655-7c4f2011585c
Name: user01
NickName: user01

User02:
ID: f22c3de5-54d0-45e2-9593-e820c4aada6f
Name: user02
NickName: user02

User03:
ID: 95296f4d-e8a5-4722-9e63-3474bf71dfcd
Name: user03
NickName: user03
```